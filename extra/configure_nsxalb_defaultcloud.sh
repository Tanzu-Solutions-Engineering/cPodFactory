#!/bin/bash
#bdereims@vmware.com

source ./env

[ "${1}" == "" ] && echo "usage: ${0} <cPod Name> <owner email>" && exit 1

if [ -f "${1}" ]; then
        . ./${COMPUTE_DIR}/"${1}"
else
        SUBNET=$( ./${COMPUTE_DIR}/cpod_ip.sh ${1} )

        [ $? -ne 0 ] && echo "error: file or env '${1}' does not exist" && exit 1

        CPOD=${1}
	unset DATASTORE
        . ./${COMPUTE_DIR}/cpod-xxx_env
fi

# import functions

source ./extra/functions.sh 
source ./extra/functions_nsxalb.sh

### Local vars ####

HOSTNAME=${HOSTNAME_NSXALB}
FQDN=${HOSTNAME_NSXALB}.${DOMAIN}

#AUTH_DOMAIN="vsphere.local"
AUTH_DOMAIN=${DOMAIN}

###################

[ "${HOSTNAME_NSXALB}" == "" ] && echo "missing parameters - please source version file !" && exit 1

CPOD_NAME="cpod-$1"
NAME_HIGHER=$( echo ${1} | tr '[:lower:]' '[:upper:]' )
CPOD_NAME_LOWER=$( echo ${CPOD_NAME} | tr '[:upper:]' '[:lower:]' )
CPOD_PORTGROUP="${CPOD_NAME_LOWER}"
VAPP="cPod-${NAME_HIGHER}"
VMNAME="${VAPP}-${HOSTNAME}"

VLAN=$( grep -m 1 "${CPOD_NAME_LOWER}\s" /etc/hosts | awk '{print $1}' | cut -d "." -f 4 )

PASSWORD=$( ./${EXTRA_DIR}/passwd_for_cpod.sh ${1} )

# ===== Start of code =====
VCENTERUSER="administrator@${DOMAIN}"
CPOD_VCSA=vcsa.${DOMAIN}

NSXALBFQDN=${HOSTNAME}.${CPOD_NAME_LOWER}.${ROOT_DOMAIN}

loop_wait_nsx_manager_status

# ===== Login with basic auth =====
echo "trying to login with cpod password"
login_nsxalb

# ===== setting args =====
echo "building curl args "
CSRFTOKEN=$(cat /tmp/cookies.txt |grep csrftoken | awk -F 'csrftoken' '{print $2}'  |tr -d '[:space:]')
declare -a curlArgs=('-H' "Content-Type: application/json")
curlArgs+=('-H' "Accept":"application/json")
curlArgs+=('-H' "x-avi-version":"${AVIVERSIONAPI}")
curlArgs+=('-H' "x-csrftoken":"${CSRFTOKEN}")
curlArgs+=('-H' "referer":"https://${NSXALBFQDN}/login")


get_cluster_info
CLOUDUUID=$(get_cluster_uuid)

# check vcenter login from alb
DATACENTER=$(vcenter_verify_login  "${VCENTERUSER}" "${PASSWORD}" "${CPOD_VCSA}")

configure_defaultcloud_vcenter "${CLOUDUUID}" "${VCENTERUSER}" "${PASSWORD}" "${CPOD_VCSA}" "${DATACENTER}"

# find mgmt portgroup for SE's
echo "get portgroups"
PORTGROUPS=$(get_portgroups "${CLOUDUUID}")
echo "${PORTGROUPS}" > /tmp/portgroups.json
echo "Mgmt portgroup"
MGMT_PORTGROUP=$(echo "${PORTGROUPS}" |jq '.resource.vcenter_pg_names[] | select (.name | contains("-management"))')

echo "${MGMT_PORTGROUP}"

echo "${MGMT_PORTGROUP}" |jq -r .uuid
get_portgroup_info "$(echo "${MGMT_PORTGROUP}" |jq -r .uuid)"

get_vrf_context



# ===== Script finished =====
echo "Configuration done"



# configure default cloud - vcenter
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vimgrvcenterruntime/verify/login' -X POST -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' 
#       --data-raw '{"username":"administrator@cpod-v8alb.az-lhr.cloud-garage.net","password":"NlPlnFh1vbF!","host":"vcsa.cpod-v8alb.az-lhr.cloud-garage.net"}'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vimgrvcenterruntime/retrieve/contentlibraries' -X POST -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' 
#       --data-raw '{"username":"administrator@cpod-v8alb.az-lhr.cloud-garage.net","password":"NlPlnFh1vbF!","host":"vcsa.cpod-v8alb.az-lhr.cloud-garage.net"}'

# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea?include_name' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' 
#       --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Default-Cloud","uuid":"cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea","name":"Default-Cloud","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin#admin","_last_modified":"1698323383028197","autoscale_polling_interval":60,"dhcp_enabled":false,"dns_resolution_on_se":false,"enable_vip_on_all_interfaces":false,"enable_vip_static_routes":false,"ip6_autocfg_enabled":false,"maintenance_mode":false,"metrics_polling_interval":300,"mtu":1500,"prefer_static_routes":false,"state_based_dns_registration":true,"vmc_deployment":false,"vtype":"CLOUD_VCENTER","vcenter_configuration":{"privilege":"WRITE_ACCESS","use_content_lib":false,"is_nsx_environment":false,"datacenter":"cPod-V8ALB","vcenter_url":"vcsa.cpod-v8alb.az-lhr.cloud-garage.net","username":"administrator@cpod-v8alb.az-lhr.cloud-garage.net","password":"NlPlnFh1vbF!"}}'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vimgrvcenterruntime/retrieve/portgroups?page_size=200' -X POST -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"cloud_uuid":"cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea"}'

# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/network/dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea?include_name=true' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/network/dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/network/dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1391-management","uuid":"dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea","name":"vlan-1391-management","vrf_context_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/vrfcontext-0753a2ff-b40c-489b-ac1f-d07aca61027f#global","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin#admin","cloud_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Default-Cloud","_last_modified":"1698395415797777","dhcp_enabled":false,"exclude_discovered_subnets":false,"ip6_autocfg_enabled":false,"synced_from_se":true,"vcenter_dvs":true,"vimgrnw_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vimgrnwruntime/dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1391-management","configured_subnets":[{"prefix":{"ip_addr":{"addr":"10.139.1.0","type":"V4"},"mask":"24"},"static_ip_ranges":[{"range":{"begin":{"addr":"10.139.1.100","type":"V4"},"end":{"addr":"10.139.1.200","type":"V4"}},"type":"STATIC_IPS_FOR_VIP_AND_SE"}]}]}'

# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea?include_name' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Default-Cloud","uuid":"cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea","name":"Default-Cloud","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin#admin","_last_modified":"1698395414341049","autoscale_polling_interval":60,"dhcp_enabled":false,"dns_resolution_on_se":false,"enable_vip_on_all_interfaces":false,"enable_vip_static_routes":false,"ip6_autocfg_enabled":false,"license_tier":"ENTERPRISE","license_type":"LIC_CORES","maintenance_mode":false,"metrics_polling_interval":60,"mtu":1500,"prefer_static_routes":false,"state_based_dns_registration":true,"vcenter_configuration":{"datacenter":"cPod-V8ALB","is_nsx_environment":false,"password":"<sensitive>","privilege":"WRITE_ACCESS","use_content_lib":false,"username":"administrator@cpod-v8alb.az-lhr.cloud-garage.net","vcenter_url":"vcsa.cpod-v8alb.az-lhr.cloud-garage.net","management_ip_subnet":{"ip_addr":{"addr":"10.139.1.0","type":"V4"},"mask":24},"management_network":"dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1391-management"},"vmc_deployment":false,"vtype":"CLOUD_VCENTER"}'

# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/vrfcontext-b97d2764-8b49-4e55-96da-7208d9ee6daa' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/vrfcontext-b97d2764-8b49-4e55-96da-7208d9ee6daa","uuid":"vrfcontext-b97d2764-8b49-4e55-96da-7208d9ee6daa","name":"management","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin","cloud_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea","_last_modified":"1698323174691088","system_default":true,"lldp_enable":true,"static_routes":[{"next_hop":{"addr":"10.139.1.1","type":"V4"},"route_id":"1","prefix":{"ip_addr":{"type":"V4","addr":"0.0.0.0"},"mask":0}}]}'

# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea?include_name' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Default-Cloud","uuid":"cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea","name":"Default-Cloud","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin#admin","_last_modified":"1698395573341392","autoscale_polling_interval":60,"dhcp_enabled":false,"dns_resolution_on_se":false,"enable_vip_on_all_interfaces":false,"enable_vip_static_routes":false,"ip6_autocfg_enabled":false,"license_tier":"ENTERPRISE","license_type":"LIC_CORES","maintenance_mode":false,"metrics_polling_interval":60,"mtu":1500,"prefer_static_routes":false,"state_based_dns_registration":true,"vcenter_configuration":{"datacenter":"cPod-V8ALB","is_nsx_environment":false,"management_ip_subnet":{"ip_addr":{"addr":"10.139.1.0","type":"V4"},"mask":24},"management_network":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vimgrnwruntime/dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1391-management","password":"<sensitive>","privilege":"WRITE_ACCESS","use_content_lib":false,"username":"administrator@cpod-v8alb.az-lhr.cloud-garage.net","vcenter_url":"vcsa.cpod-v8alb.az-lhr.cloud-garage.net"},"vmc_deployment":false,"vtype":"CLOUD_VCENTER"}'

# create ipam profile
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/networksubnetlist/?cloud_uuid=cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea&page_size=12&page=1&include_name=true' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/ipamdnsproviderprofile?include_name' -X POST -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"internal_profile":{"ttl":30,"usable_networks":[{"nw_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/network/dvportgroup-25-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1393-frontend"}]},"allocate_ip_in_vrf":false,"type":"IPAMDNS_TYPE_INTERNAL","name":"avi-ipam"}'

# add ipam profile to cloud
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/ipamdnsproviderprofile/?type=IPAMDNS_TYPE_AWS_DNS%2CIPAMDNS_TYPE_AZURE_DNS%2CIPAMDNS_TYPE_CUSTOM_DNS%2CIPAMDNS_TYPE_INFOBLOX_DNS%2CIPAMDNS_TYPE_INTERNAL_DNS&exclude=type&page_size=12&page=1&include_name=true' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/network/dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/network/dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1391-management","uuid":"dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea","name":"vlan-1391-management","vrf_context_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/vrfcontext-0753a2ff-b40c-489b-ac1f-d07aca61027f#global","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin#admin","cloud_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Default-Cloud","_last_modified":"1698395573161389","configured_subnets":[{"prefix":{"ip_addr":{"addr":"10.139.1.0","type":"V4"},"mask":"24"},"static_ip_ranges":[{"range":{"begin":{"addr":"10.139.1.100","type":"V4"},"end":{"addr":"10.139.1.200","type":"V4"}},"type":"STATIC_IPS_FOR_VIP_AND_SE"}]}],"dhcp_enabled":false,"exclude_discovered_subnets":false,"ip6_autocfg_enabled":false,"synced_from_se":true,"vcenter_dvs":true,"vimgrnw_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vimgrnwruntime/dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1391-management"}'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea?include_name' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Default-Cloud","uuid":"cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea","name":"Default-Cloud","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin#admin","_last_modified":"1698395573640071","autoscale_polling_interval":60,"dhcp_enabled":false,"dns_resolution_on_se":false,"enable_vip_on_all_interfaces":false,"enable_vip_static_routes":false,"ip6_autocfg_enabled":false,"license_tier":"ENTERPRISE","license_type":"LIC_CORES","maintenance_mode":false,"metrics_polling_interval":60,"mtu":1500,"prefer_static_routes":false,"state_based_dns_registration":true,"vcenter_configuration":{"datacenter":"cPod-V8ALB","is_nsx_environment":false,"management_ip_subnet":{"ip_addr":{"addr":"10.139.1.0","type":"V4"},"mask":24},"management_network":"dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1391-management","password":"<sensitive>","privilege":"WRITE_ACCESS","use_content_lib":false,"username":"administrator@cpod-v8alb.az-lhr.cloud-garage.net","vcenter_url":"vcsa.cpod-v8alb.az-lhr.cloud-garage.net"},"vmc_deployment":false,"vtype":"CLOUD_VCENTER","ipam_provider_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/ipamdnsproviderprofile/ipamdnsproviderprofile-582448ca-b0af-4706-8eaa-767ae0773a2c#avi-ipam"}'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/vrfcontext-b97d2764-8b49-4e55-96da-7208d9ee6daa' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"_last_modified":"1698395573498270","cloud_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea","lldp_enable":true,"name":"management","static_routes":[{"next_hop":{"addr":"10.139.1.1","type":"V4"},"prefix":{"ip_addr":{"addr":"0.0.0.0","type":"V4"},"mask":0},"route_id":"1"}],"system_default":true,"tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin","url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/vrfcontext-b97d2764-8b49-4e55-96da-7208d9ee6daa","uuid":"vrfcontext-b97d2764-8b49-4e55-96da-7208d9ee6daa"}'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea?include_name' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Default-Cloud","uuid":"cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea","name":"Default-Cloud","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin#admin","_last_modified":"1698395878795594","autoscale_polling_interval":60,"dhcp_enabled":false,"dns_resolution_on_se":false,"enable_vip_on_all_interfaces":false,"enable_vip_static_routes":false,"ip6_autocfg_enabled":false,"ipam_provider_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/ipamdnsproviderprofile/ipamdnsproviderprofile-582448ca-b0af-4706-8eaa-767ae0773a2c#avi-ipam","license_tier":"ENTERPRISE","license_type":"LIC_CORES","maintenance_mode":false,"metrics_polling_interval":60,"mtu":1500,"prefer_static_routes":false,"state_based_dns_registration":true,"vcenter_configuration":{"datacenter":"cPod-V8ALB","is_nsx_environment":false,"management_ip_subnet":{"ip_addr":{"addr":"10.139.1.0","type":"V4"},"mask":24},"management_network":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vimgrnwruntime/dvportgroup-23-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1391-management","password":"<sensitive>","privilege":"WRITE_ACCESS","use_content_lib":false,"username":"administrator@cpod-v8alb.az-lhr.cloud-garage.net","vcenter_url":"vcsa.cpod-v8alb.az-lhr.cloud-garage.net"},"vmc_deployment":false,"vtype":"CLOUD_VCENTER"}'

# default service engine group - placement
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/serviceenginegroup-inventory/?step=300&limit=72&cloud_ref.uuid=cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea&sort=name&page_size=10&page=1&include=config%2Cupgradestatus&include_name=true' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vimgrclusterruntime/?fields=name%2C%20tenant_ref&cloud_ref.uuid=cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea&sort=name&page_size=12&page=1&include_name=true' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/object-graph?refers_to=serviceenginegroup%3Aserviceenginegroup-57a86fb0-b646-452d-9ed4-eb5024f1f202&fields=name' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' 
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/serviceenginegroup/serviceenginegroup-57a86fb0-b646-452d-9ed4-eb5024f1f202?include_name' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/serviceenginegroup/serviceenginegroup-57a86fb0-b646-452d-9ed4-eb5024f1f202#Default-Group","uuid":"serviceenginegroup-57a86fb0-b646-452d-9ed4-eb5024f1f202","name":"Default-Group","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin#admin","cloud_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Default-Cloud","_last_modified":"1698323383116823","accelerated_networking":true,"active_standby":false,"aggressive_failure_detection":false,"algo":"PLACEMENT_ALGO_PACKED","app_cache_percent":10,"app_cache_threshold":5,"app_learning_memory_percent":0,"archive_shm_limit":8,"async_ssl":false,"async_ssl_threads":1,"auto_rebalance":false,"auto_rebalance_interval":300,"auto_redistribute_active_standby_load":false,"baremetal_dispatcher_handles_flows":false,"bgp_peer_monitor_failover_enabled":false,"bgp_state_update_interval":60,"buffer_se":1,"compress_ip_rules_for_each_ns_subnet":true,"config_debugs_on_all_cores":false,"connection_memory_percentage":50,"core_shm_app_cache":false,"core_shm_app_learning":false,"cpu_reserve":false,"cpu_socket_affinity":false,"datascript_timeout":1000000,"disable_avi_securitygroups":false,"disable_csum_offloads":false,"disable_flow_probes":false,"disable_se_memory_check":false,"disable_tso":false,"disk_per_se":15,"distribute_load_active_standby":false,"distribute_queues":false,"distribute_vnics":false,"downstream_send_timeout":3600000,"dp_aggressive_deq_interval_msec":1,"dp_aggressive_enq_interval_msec":1,"dp_aggressive_hb_frequency":100,"dp_aggressive_hb_timeout_count":10,"dp_deq_interval_msec":20,"dp_enq_interval_msec":20,"dp_hb_frequency":100,"dp_hb_timeout_count":10,"dpdk_gro_timeout_interval":50,"enable_gratarp_permanent":false,"enable_hsm_log":false,"enable_hsm_priming":false,"enable_multi_lb":false,"extra_config_multiplier":0,"extra_shared_config_memory":0,"flow_table_new_syn_max_entries":0,"free_list_size":1024,"gratarp_permanent_periodicity":10,"grpc_channel_connect_timeout":15,"ha_mode":"HA_MODE_SHARED","handle_per_pkt_attack":true,"heap_minimum_config_memory":8,"hm_on_standby":true,"host_gateway_monitor":false,"http_rum_console_log":false,"http_rum_min_content_length":64,"hybrid_rss_mode":false,"ignore_docker_mac_change":true,"ignore_rtt_threshold":5000,"ingress_access_data":"SG_INGRESS_ACCESS_ALL","ingress_access_mgmt":"SG_INGRESS_ACCESS_ALL","l7_conns_per_core":16384,"l7_resvd_listen_conns_per_core":256,"lbaction_num_requests_to_dispatch":4,"lbaction_rq_per_request_max_retries":22,"least_load_core_selection":true,"license_tier":"ENTERPRISE","license_type":"LIC_CORES","log_agent_compress_logs":true,"log_agent_debug_enabled":false,"log_agent_file_sz_appl":4,"log_agent_file_sz_conn":4,"log_agent_file_sz_debug":4,"log_agent_file_sz_event":4,"log_agent_log_storage_min_sz":1024,"log_agent_max_concurrent_rsync":1024,"log_agent_max_storage_excess_percent":110,"log_agent_max_storage_ignore_percent":20,"log_agent_min_storage_per_vs":10,"log_agent_sleep_interval":10,"log_agent_trace_enabled":true,"log_agent_unknown_vs_timer":1800,"log_disksz":10000,"log_malloc_failure":true,"log_message_max_file_list_size":64,"max_cpu_usage":80,"max_memory_per_mempool":64,"max_public_ips_per_lb":30,"max_queues_per_vnic":1,"max_rules_per_lb":150,"max_scaleout_per_vs":4,"max_se":10,"max_skb_frags":17,"max_vs_per_se":10,"mem_reserve":true,"memory_for_config_update":15,"memory_per_se":2048,"min_cpu_usage":30,"min_scaleout_per_vs":1,"min_se":1,"minimum_connection_memory":20,"n_log_streaming_threads":1,"netlink_poller_threads":2,"netlink_sock_buf_size":4,"ngx_free_connection_stack":false,"non_significant_log_throttle":100,"ns_helper_deq_interval_msec":20,"ntp_sync_fail_event":false,"ntp_sync_status_interval":0,"num_dispatcher_cores":0,"num_dispatcher_queues":1,"num_flow_cores_sum_changes_to_ignore":8,"objsync_port":9001,"os_reserved_memory":0,"pcap_tx_mode":"PCAP_TX_AUTO","pcap_tx_ring_rd_balancing_factor":10,"per_app":false,"per_vs_admission_control":false,"placement_mode":"PLACEMENT_MODE_AUTO","reboot_on_panic":true,"replay_vrf_routes_interval":1000,"resync_time_interval":65536,"sdb_flush_interval":100,"sdb_pipeline_size":100,"sdb_scan_count":1000,"se_bandwidth_type":"SE_BANDWIDTH_UNLIMITED","se_delayed_flow_delete":true,"se_deprovision_delay":120,"se_dp_hm_drops":0,"se_dp_if_state_poll_interval":10,"se_dp_isolation":false,"se_dp_isolation_num_non_dp_cpus":0,"se_dp_log_nf_enqueue_percent":70,"se_dp_log_udf_enqueue_percent":90,"se_dp_max_hb_version":3,"se_dp_vnic_queue_stall_event_sleep":0,"se_dp_vnic_queue_stall_threshold":2000,"se_dp_vnic_queue_stall_timeout":10000,"se_dp_vnic_restart_on_queue_stall_count":3,"se_dp_vnic_stall_se_restart_window":3600,"se_dpdk_pmd":0,"se_dump_core_on_assert":false,"se_emulated_cores":0,"se_flow_probe_retries":2,"se_flow_probe_retry_timer":40,"se_hyperthreaded_mode":"SE_CPU_HT_AUTO","se_ip_encap_ipc":0,"se_kni_burst_factor":0,"se_l3_encap_ipc":0,"se_log_buffer_app_blocking_dequeue":false,"se_log_buffer_conn_blocking_dequeue":false,"se_log_buffer_events_blocking_dequeue":true,"se_mp_ring_retry_count":500,"se_name_prefix":"Avi","se_packet_buffer_max":0,"se_pcap_lookahead":false,"se_pcap_pkt_count":0,"se_pcap_pkt_sz":69632,"se_pcap_qdisc_bypass":true,"se_pcap_reinit_frequency":0,"se_pcap_reinit_threshold":0,"se_probe_port":7,"se_rum_sampling_nav_interval":1,"se_rum_sampling_nav_percent":1,"se_rum_sampling_res_interval":2,"se_rum_sampling_res_percent":100,"se_sb_dedicated_core":false,"se_sb_threads":1,"se_thread_multiplier":1,"se_time_tracker_props":{"egress_audit_mode":"SE_TT_AUDIT_OFF","egress_threshold":20,"event_gen_window":300,"ingress_audit_mode":"SE_TT_AUDIT_OFF","ingress_threshold":20},"se_tunnel_mode":0,"se_tunnel_udp_port":1550,"se_tx_batch_size":64,"se_txq_threshold":2048,"se_udp_encap_ipc":0,"se_use_dpdk":0,"se_vnic_tx_sw_queue_flush_frequency":0,"se_vnic_tx_sw_queue_size":256,"se_vs_hb_max_pkts_in_batch":64,"se_vs_hb_max_vs_in_pkt":256,"self_se_election":false,"send_se_ready_timeout":300,"shm_minimum_config_memory":4,"significant_log_throttle":100,"ssl_preprocess_sni_hostname":true,"ssl_sess_cache_per_vs":4096,"transient_shared_memory_max":30,"udf_log_throttle":100,"upstream_connect_timeout":3600000,"upstream_connpool_enable":true,"upstream_read_timeout":3600000,"upstream_send_timeout":3600000,"use_dp_util_for_scaleout":false,"use_hyperthreaded_cores":true,"use_legacy_netlink":false,"use_objsync":true,"user_defined_metric_age":60,"vcenter_datastore_mode":"VCENTER_DATASTORE_SHARED","vcenter_datastores_include":true,"vcenter_folder":"AviSeFolder","vcpus_per_se":1,"vnic_dhcp_ip_check_interval":6,"vnic_dhcp_ip_max_retries":10,"vnic_ip_delete_interval":5,"vnic_probe_interval":5,"vnic_rpc_retry_interval":5,"vnicdb_cmd_history_size":256,"vs_host_redundancy":true,"vs_scalein_timeout":30,"vs_scalein_timeout_for_upgrade":30,"vs_scaleout_timeout":600,"vs_se_scaleout_additional_wait_time":0,"vs_se_scaleout_ready_timeout":60,"vs_switchover_timeout":300,"vss_placement_enabled":false,"waf_mempool":true,"waf_mempool_size":64,"service_ip_subnets":[],"auto_rebalance_criteria":[],"auto_rebalance_capacity_per_se":[],"vcenter_clusters":{"include":true,"cluster_refs":["https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vimgrclusterruntime/domain-c8-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Cluster"]},"realtime_se_metrics":{"enabled":false,"duration":30},"user_agent_cache_config":{"se_cache_size":20000,"controller_cache_size":300000,"percent_reserved_for_outstanding":10,"percent_reserved_for_browsers":50,"percent_reserved_for_good_bots":20,"percent_reserved_for_bad_bots":20,"batch_size":100,"max_wait_time":60,"upstream_update_interval":3600,"num_entries_upstream_update":100,"max_upstream_queries":5,"max_age":86400,"max_last_hit_time":86400},"vcenter_datastores":[{"managed_object_id":"datastore-31"}]}'

# Set networks ipam ranges 
# Frontend
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/network/dvportgroup-25-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea?include_name=true' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/?exclude=name.in&name.in=management&cloud_ref.uuid=cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea&fields=name%2Ctenant_ref&page_size=45&page=1&include_name=true' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/object-graph?refers_to=network%3Advportgroup-25-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea&fields=name' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/network/dvportgroup-25-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/network/dvportgroup-25-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1393-frontend","uuid":"dvportgroup-25-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea","name":"vlan-1393-frontend","vrf_context_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/vrfcontext-0753a2ff-b40c-489b-ac1f-d07aca61027f#global","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin#admin","cloud_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Default-Cloud","_last_modified":"1698395415850543","dhcp_enabled":false,"exclude_discovered_subnets":false,"ip6_autocfg_enabled":false,"synced_from_se":true,"vcenter_dvs":true,"vimgrnw_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vimgrnwruntime/dvportgroup-25-cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#vlan-1393-frontend","configured_subnets":[{"asString":"","prefix":{"ip_addr":{"addr":"10.139.3.0","type":"V4"},"mask":"24"},"static_ip_ranges":[{"range":{"begin":{"addr":"10.139.3.2","type":"V4"},"end":{"addr":"10.139.3.150","type":"V4"}},"type":"STATIC_IPS_FOR_VIP_AND_SE"}]}]}'

# Set VRF context
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/?exclude=name.in&name.in=management&cloud_ref.uuid=cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea&sort=name&page_size=10&page=1&include_name=true' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/vrfcontext-0753a2ff-b40c-489b-ac1f-d07aca61027f?include_name=true' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers'
# curl 'https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/vrfcontext-0753a2ff-b40c-489b-ac1f-d07aca61027f?include_name' -X PUT -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/118.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'Referer: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/' -H 'X-Avi-UserAgent: UI' -H 'X-Avi-Version: 22.1.4' -H 'X-Avi-Tenant: admin' -H 'Content-Type: application/json;charset=utf-8' -H 'X-CSRFToken: Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm' -H 'Origin: https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net' -H 'Connection: keep-alive' -H 'Cookie: csrftoken=Ix4pDXABLlZcjkNr3NmkHEKWwAIQoRJm; avi-sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az; sessionid=moanoz5jflrgs1cfpzi73puhy03wc8az' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: same-origin' -H 'TE: trailers' --data-raw '{"url":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/vrfcontext/vrfcontext-0753a2ff-b40c-489b-ac1f-d07aca61027f#global","uuid":"vrfcontext-0753a2ff-b40c-489b-ac1f-d07aca61027f","name":"global","tenant_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/tenant/admin#admin","cloud_ref":"https://nsxalb01.cpod-v8alb.az-lhr.cloud-garage.net/api/cloud/cloud-89a795f5-52e1-4d23-8184-6e9c992d0aea#Default-Cloud","_last_modified":"1698323174657001","system_default":true,"lldp_enable":true,"static_routes":[{"prefix":{"ip_addr":{"addr":"0.0.0.0","type":"V4"},"mask":0},"next_hop":{"addr":"10.139.3.1","type":"V4"},"route_id":"1"}],"bfd_profile":{}}'
